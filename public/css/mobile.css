.desktop-only {
    display: none !important;
}

@media (max-width: 768px) {

    body {
        align-items: flex-start;
    }

    .chat-container {
        padding: 0;
        height: 100%;
        width: 100vw;
        gap: 0;
    }

    .sidebar {
        width: 100%;
        border-radius: 0;
        border: none;
        display: flex;
        height: 100%;
        overflow-y: hidden;
        background-color: #050505;
        /* isolation: isolate; REMOVED to fix stacking context for Dock vs Settings */
    }

    .main-column {
        display: none;
        width: 100%;
        border-radius: 0;
        border: none;
        height: 100%;
    }

    .chat-container.mobile-chat-active .sidebar {
        display: none;
    }

    .chat-container.mobile-chat-active .main-column {
        display: flex;
        height: 100%;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 50;
    }

    .back-btn {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .custom-audio-player {
        width: 220px;
        gap: 8px;
    }

    .audio-avatar-img {
        width: 42px;
        height: 42px;
    }

    .audio-control-btn svg {
        width: 26px;
        height: 26px;
    }

    .audio-right-col {
        height: 38px;
    }

    .audio-slider-container {
        height: 18px;
    }

    .scroll-bottom-btn {
        bottom: 80px;
        right: 15px;
    }

    .sticker-panel {
        position: relative;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 40vh;
        max-height: 350px;
        border-radius: 20px 20px 0 0;
        border: none;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        z-index: 2000;
        box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.5);
    }

    .sticker-panel.hidden {
        display: none;
        transform: translateY(100%);
    }

    .sticker-panel.open {
        height: 320px;
    }

    /* Floating Dock Mobile Overrides (Full Width Bottom Bar) */
    .floating-dock-container {
        bottom: 0;
        width: 100%;
        padding: 0;
        transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        will-change: transform;
    }

    .floating-dock {
        width: 100%;
        border-radius: 24px 24px 0 0;
        border: none;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding: 15px 20px;
        /* Adjust padding for bar look */
        padding-bottom: max(15px, env(safe-area-inset-bottom));
        /* Safe area for iPhone home bar */
        justify-content: space-around;
        box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.4);
        background: rgba(10, 10, 12, 0.95);
        /* Slightly darker/solid for nav bar */
        backdrop-filter: blur(20px);
    }

    /* --- MOBILE SEARCH BEHAVIOR (MARGIN-FIT) --- */

    /*
       WHY MARGIN?: "Transform" moves the element but leaves a gap at the bottom (Black Box)
       because the container does not resize. To fill the screen (especially with keyboard),
       we MUST physically collapse the header space.
       
       OPTIMIZATION: We use 'will-change: margin-top' to hint the browser.
       We DO NOT change padding on the search bar during animation to avoid internal reflows.
    */

    .brand-header {
        /* Fluid margins to avoid black box gaps */
        transition: margin-top 0.35s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        will-change: margin-top, opacity;
        opacity: 1;
        margin-top: 0;
    }

    .favorites-section {
        transition: opacity 0.2s cubic-bezier(0.2, 0.8, 0.2, 1), height 0.35s cubic-bezier(0.2, 0.8, 0.2, 1);
        opacity: 1;
        transform: translateZ(0);
    }

    body.mobile-search-active .brand-header {
        /* Collapse layout naturally to pull search bar and list up fluidly */
        margin-top: calc(var(--search-move-up, 140px) * -1);
        opacity: 0;
        pointer-events: none;
    }



    body.mobile-search-active .favorites-section {
        opacity: 0;
        pointer-events: none;
    }

    /* Search Container */
    .search-trigger {
        /* Sticky ensures it latches to the top as we scroll/move */
        position: sticky;
        top: 0;
        z-index: 20;
        background: #050505;

        transition: background 0.2s ease;
        padding-bottom: 10px;
        /* Keep padding stable */
    }

    body.mobile-search-active .search-trigger {
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    /* Users list grows automatically due to flex layout when header collapses */
    body.mobile-search-active .users-list {
        padding-bottom: 20px !important;
        /* override the default 100px so no bottom gap */
    }


    /* Aggressively hide bottom elements so they don't float over keyboard */
    body.mobile-search-active .floating-dock-container,
    body.mobile-search-active .sticker-panel,
    body.mobile-search-active .scroll-bottom-btn,
    body.mobile-search-active .composer {
        display: none !important;
    }

    /* --- ICON ANIMATION --- */
    .fake-search {
        position: relative;
        background: rgba(255, 255, 255, 0.05);
    }

    .fake-search input {
        margin-left: 28px;
        width: calc(100% - 28px);
        transition: all 0.2s ease;
    }

    .search-icon,
    .search-back-btn {
        position: absolute;
        left: 15px;
        top: 50%;
        margin: 0;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* Magnifier */
    .search-icon {
        opacity: 1;
        transform: translateY(-50%) rotate(0deg) scale(1);
    }

    /* Back Arrow */
    .search-back-btn {
        opacity: 0;
        transform: translateY(-50%) rotate(-90deg) scale(0.5);
        pointer-events: none;
    }

    /* Active States */
    body.mobile-search-active .search-icon {
        opacity: 0;
        transform: translateY(-50%) rotate(90deg) scale(0.5);
    }

    body.mobile-search-active .search-back-btn {
        opacity: 1;
        transform: translateY(-50%) rotate(0deg) scale(1);
        pointer-events: auto;
    }

    /* --- SELECTION MODE --- */
    .mobile-selection-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        height: 60px;
        background-color: #050505;
        position: sticky;
        top: 0;
        z-index: 30;
        width: 100%;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    .mobile-selection-header.hidden {
        display: none !important;
    }

    .selection-left,
    .selection-right {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .selection-count {
        font-size: 18px;
        font-weight: 600;
        color: #fff;
    }

    /* Hide standard header elements when selection is active */
    body.selection-active .brand-header,
    body.selection-active .favorites-section,
    /* Keep search trigger visible but maybe adjust if needed. 
       User requirement: "The search input should remain visible." 
       But if it sticks, does it conflict with selection header?
       The selection header is position:sticky top:0.
       The search trigger is position:sticky top:0.
       They will overlap.
       We should probably hide the search trigger OR put the selection header BELOW it?
       User said: "The search input should remain visible."
       So we should NOT hide search-trigger.
       But if selection header is at top, maybe search trigger should be hidden?
       Refining plan: Show both?
       If I leave search trigger, it takes space.
       Let's try hiding brand-header and favorites-section, but keeping search-trigger.
       And placing selection header... where?
       If selection header replaces brand-header, it effectively sits above search.
    */
    body.selection-active .brand-header,
    body.selection-active .favorites-section {
        display: none !important;
    }

    /* 
       If search trigger remains visible, it is sticky at top:0.
       If selection header is also sticky at top:0, they overlap.
       Maybe selection header should be relative in DOM (it is) and we hide brand header?
       If we hide brand header, selection header takes its place in flow.
       Then search trigger follows.
       So selection header should NOT be sticky if search trigger is sticky?
       Or both sticky?
       Let's make selection header position: sticky top: 0.
    */

    .user-item {
        transition: background-color 0.2s;
        position: relative;
    }

    .user-item.selected {
        background-color: rgba(59, 130, 246, 0.15) !important;
    }

    .selection-check {
        position: absolute;
        bottom: -2px;
        right: -2px;
        width: 20px;
        height: 20px;
        background: #3b82f6;
        border: 2px solid #000;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: bold;
        opacity: 0;
        transform: scale(0.5);
        transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        z-index: 10;
        pointer-events: none;
    }

    .user-item.selected .selection-check {
        opacity: 1;
        transform: scale(1);
    }

    .user-item .card-avatar,
    .user-item .u-avatar {
        position: relative;
    }
}